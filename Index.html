<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>JARVIS Â· Translator</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
â€“cyan: #00d4ff;
â€“gold: #ffaa00;
â€“dark: #020810;
â€“panel: rgba(0, 180, 255, 0.05);
â€“border: rgba(0, 212, 255, 0.25);
â€“glow: 0 0 20px rgba(0, 212, 255, 0.4);
}

html, body {
width: 100%; height: 100%;
background: var(â€“dark);
overflow: hidden;
font-family: â€˜Share Tech Monoâ€™, monospace;
color: var(â€“cyan);
user-select: none;
-webkit-user-select: none;
}

body::before {
content: â€˜â€™;
position: fixed; inset: 0;
background-image:
linear-gradient(rgba(0,212,255,0.04) 1px, transparent 1px),
linear-gradient(90deg, rgba(0,212,255,0.04) 1px, transparent 1px);
background-size: 40px 40px;
animation: gridMove 20s linear infinite;
pointer-events: none;
z-index: 0;
}
@keyframes gridMove { from{background-position:0 0} to{background-position:40px 40px} }

body::after {
content: â€˜â€™;
position: fixed; inset: 0;
background: radial-gradient(ellipse at center, transparent 30%, rgba(2,8,16,0.85) 100%);
pointer-events: none;
z-index: 0;
}

.app {
position: relative;
z-index: 1;
width: 100vw; height: 100vh;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
gap: 12px;
padding: 70px 16px 60px;
}

/* CORNERS */
.corner { position: absolute; width: 28px; height: 28px; border-color: var(â€“cyan); border-style: solid; opacity: 0.4; }
.corner.tl { top: 8px; left: 8px; border-width: 2px 0 0 2px; }
.corner.tr { top: 8px; right: 8px; border-width: 2px 2px 0 0; }
.corner.bl { bottom: 8px; left: 8px; border-width: 0 0 2px 2px; }
.corner.br { bottom: 8px; right: 8px; border-width: 0 2px 2px 0; }

/* TOP HUD */
.hud-top {
position: absolute;
top: 0; left: 0; right: 0;
padding: 12px 20px;
display: flex;
align-items: center;
justify-content: space-between;
border-bottom: 1px solid var(â€“border);
background: linear-gradient(to bottom, rgba(0,212,255,0.07), transparent);
}
.hud-title {
font-family: â€˜Orbitronâ€™, sans-serif;
font-size: 0.85rem;
font-weight: 900;
letter-spacing: 0.25em;
color: var(â€“cyan);
text-shadow: var(â€“glow);
}
.hud-title span { color: var(â€“gold); }
.hud-sys {
font-size: 0.6rem;
letter-spacing: 0.1em;
color: var(â€“gold);
display: flex; align-items: center; gap: 6px;
}
.dot-blink {
width: 5px; height: 5px; border-radius: 50%;
background: var(â€“gold);
animation: blink 2s infinite;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

/* WAVEFORM */
.waveform {
display: flex; align-items: center; justify-content: center; gap: 3px;
height: 44px; width: 100%; max-width: 360px;
}
.wbar {
width: 3px; background: var(â€“cyan); border-radius: 2px;
height: 4px; opacity: 0.15; transition: height 0.08s ease;
}

/* PANELS */
.panels {
display: flex; gap: 12px; width: 100%; max-width: 700px;
}
.panel {
flex: 1;
background: var(â€“panel);
border: 1px solid var(â€“border);
border-radius: 6px;
padding: 10px 12px;
position: relative; overflow: hidden;
min-height: 90px;
}
.panel::before {
content: â€˜â€™; position: absolute; top: 0; left: 0; right: 0;
height: 2px;
background: linear-gradient(to right, transparent, var(â€“cyan), transparent);
opacity: 0.3; transition: opacity 0.3s;
}
.panel.lit::before { opacity: 1; }
.panel-lang {
font-family: â€˜Orbitronâ€™, sans-serif;
font-size: 0.55rem; letter-spacing: 0.2em;
color: rgba(0,212,255,0.5); margin-bottom: 6px;
display: flex; align-items: center; gap: 5px;
}
.panel-orig {
font-size: 0.78rem; color: rgba(0,212,255,0.55);
font-style: italic; line-height: 1.5; min-height: 1.5em;
margin-bottom: 5px;
}
.panel-trans {
font-family: â€˜Orbitronâ€™, sans-serif;
font-size: 0.78rem; color: var(â€“gold);
line-height: 1.5; min-height: 1.5em;
text-shadow: 0 0 8px rgba(255,170,0,0.4);
}

/* CENTER RING */
.center-ring {
position: relative;
width: 180px; height: 180px; flex-shrink: 0;
}
.ring {
position: absolute; border-radius: 50%;
border-style: solid; border-color: transparent;
}
.ring-1 {
inset: 0; border-width: 2px;
border-top-color: var(â€“cyan); border-right-color: var(â€“cyan);
animation: spin 3s linear infinite;
box-shadow: 0 0 12px rgba(0,212,255,0.3);
}
.ring-2 {
inset: 10px; border-width: 1px;
border-bottom-color: rgba(0,212,255,0.4); border-left-color: rgba(0,212,255,0.4);
animation: spin 5s linear infinite reverse;
}
.ring-3 {
inset: 20px; border-width: 1px;
border-top-color: var(â€“gold); border-right-color: var(â€“gold);
animation: spin 7s linear infinite; opacity: 0.5;
}
@keyframes spin { to { transform: rotate(360deg); } }

.pulse-ring {
position: absolute; inset: 0; border-radius: 50%;
border: 2px solid var(â€“cyan); opacity: 0;
}
.listening .pulse-ring {
animation: pulseOut 1.5s ease-out infinite;
}
@keyframes pulseOut { 0%{transform:scale(1);opacity:0.6} 100%{transform:scale(1.5);opacity:0} }

.ring-inner {
position: absolute; inset: 32px;
border-radius: 50%;
background: radial-gradient(circle, rgba(0,100,200,0.15) 0%, rgba(0,212,255,0.05) 60%, transparent 100%);
border: 1px solid var(â€“border);
display: flex; align-items: center; justify-content: center;
flex-direction: column; gap: 4px;
cursor: pointer;
transition: all 0.3s;
-webkit-tap-highlight-color: transparent;
}
.ring-inner.on {
background: radial-gradient(circle, rgba(0,212,255,0.2) 0%, rgba(0,100,255,0.1) 60%, transparent 100%);
box-shadow: 0 0 25px rgba(0,212,255,0.25) inset;
}
.ring-inner.hearing {
background: radial-gradient(circle, rgba(255,170,0,0.2) 0%, rgba(0,212,255,0.1) 60%, transparent 100%);
}
#powerIcon { font-size: 1.8rem; line-height: 1; }
#powerLabel {
font-family: â€˜Orbitronâ€™, sans-serif;
font-size: 0.5rem; letter-spacing: 0.18em;
color: rgba(0,212,255,0.6); text-align: center;
}

/* STATUS */
.status-line {
font-size: 0.65rem; letter-spacing: 0.1em;
color: var(â€“cyan); text-align: center;
text-shadow: 0 0 8px rgba(0,212,255,0.4);
min-height: 20px;
}

/* â˜… BOUTON Ã‰COUTER â€” affichÃ© aprÃ¨s chaque traduction sur iOS */
#listenBtn {
display: none;
align-items: center; justify-content: center;
gap: 8px;
padding: 12px 28px;
background: rgba(255,170,0,0.12);
border: 1px solid var(â€“gold);
border-radius: 40px;
color: var(â€“gold);
font-family: â€˜Orbitronâ€™, sans-serif;
font-size: 0.7rem;
letter-spacing: 0.2em;
cursor: pointer;
animation: glowPulse 1.5s ease infinite;
-webkit-tap-highlight-color: transparent;
box-shadow: 0 0 20px rgba(255,170,0,0.2);
}
#listenBtn.visible { display: flex; }
@keyframes glowPulse {
0%,100%{box-shadow:0 0 20px rgba(255,170,0,0.2)}
50%{box-shadow:0 0 35px rgba(255,170,0,0.5)}
}

/* HISTORY */
.history {
width: 100%; max-width: 700px;
display: flex; flex-direction: column; gap: 3px;
overflow: hidden; max-height: 60px;
}
.hist {
font-size: 0.6rem; color: rgba(0,212,255,0.3);
white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
animation: slideIn 0.3s ease;
}
@keyframes slideIn { from{opacity:0;transform:translateX(-8px)} to{opacity:1;transform:none} }

/* BOTTOM HUD */
.hud-bottom {
position: absolute; bottom: 0; left: 0; right: 0;
padding: 8px 20px;
border-top: 1px solid var(â€“border);
display: flex; align-items: center; justify-content: space-between;
font-size: 0.55rem; letter-spacing: 0.1em;
color: rgba(0,212,255,0.2);
}
#convCount {
font-family: â€˜Orbitronâ€™, sans-serif;
font-size: 1.1rem; font-weight: 900;
color: rgba(0,212,255,0.15);
}
</style>

</head>
<body>

<div class="app">

  <div class="corner tl"></div>
  <div class="corner tr"></div>
  <div class="corner bl"></div>
  <div class="corner br"></div>

  <div class="hud-top">
    <div class="hud-title">JARVIS <span>TRANSLATE</span></div>
    <div class="hud-sys"><div class="dot-blink"></div><span id="sysStatus">VEILLE</span></div>
  </div>

  <div class="waveform" id="waveform"></div>

  <div class="panels">
    <div class="panel" id="panelFr">
      <div class="panel-lang">ğŸ‡«ğŸ‡· <span>FRANÃ‡AIS</span></div>
      <div class="panel-orig" id="origFr">â€”</div>
      <div class="panel-trans" id="transFr">â€”</div>
    </div>
    <div class="panel" id="panelEs">
      <div class="panel-lang">ğŸ‡ªğŸ‡¸ <span>ESPAÃ‘OL</span></div>
      <div class="panel-orig" id="origEs">â€”</div>
      <div class="panel-trans" id="transEs">â€”</div>
    </div>
  </div>

  <div class="center-ring" id="centerRing">
    <div class="pulse-ring"></div>
    <div class="ring ring-1"></div>
    <div class="ring ring-2"></div>
    <div class="ring ring-3"></div>
    <div class="ring-inner" id="powerBtn">
      <div id="powerIcon">â»</div>
      <div id="powerLabel">DÃ‰MARRER</div>
    </div>
  </div>

  <div class="status-line" id="mainStatus">EN ATTENTE</div>

  <!-- Bouton tap iOS pour dÃ©clencher le son -->

<button id="listenBtn" onclick="playPending()">ğŸ”Š Â Ã‰COUTER LA TRADUCTION</button>

  <div class="history" id="history"></div>

  <div class="hud-bottom">
    <span>JARVIS NEURAL TRANSLATE</span>
    <span>FR â‡„ ES AUTO-DETECT</span>
    <span id="convCount">00</span>
  </div>
</div>

<script>
// â”€â”€ WAVEFORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const waveEl = document.getElementById('waveform');
const wbars = [];
for (let i = 0; i < 40; i++) {
  const b = document.createElement('div');
  b.className = 'wbar';
  waveEl.appendChild(b);
  wbars.push(b);
}
let waveTimer;
function startWave() {
  clearInterval(waveTimer);
  waveTimer = setInterval(() => {
    wbars.forEach((b, i) => {
      const h = Math.max(4, Math.sin(Date.now()/180 + i*0.45)*16 + Math.random()*18);
      b.style.height = h + 'px';
      b.style.opacity = 0.6 + Math.random()*0.4;
    });
  }, 65);
}
function stopWave() {
  clearInterval(waveTimer);
  wbars.forEach(b => { b.style.height = '4px'; b.style.opacity = '0.15'; });
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let running = false;
let speaking = false;
let recognition = null;
let silenceTimer = null;
let convCount = 0;
let pendingText = null;
let pendingLang = null;

const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

// â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const setStatus  = t => document.getElementById('mainStatus').textContent = t;
const setSys     = t => document.getElementById('sysStatus').textContent = t;
const listenBtn  = document.getElementById('listenBtn');

function setListening(on) {
  document.getElementById('centerRing').classList.toggle('listening', on);
  document.getElementById('powerBtn').classList.toggle('hearing', on);
  on ? startWave() : stopWave();
}

function flashPanel(lang) {
  const el = document.getElementById(lang === 'fr' ? 'panelFr' : 'panelEs');
  el.classList.add('lit');
  setTimeout(() => el.classList.remove('lit'), 2500);
}

// â”€â”€ LANGUE DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function detectLang(text) {
  const t = text.toLowerCase();
  const esW = ['el','la','los','las','un','una','que','de','en','con','por','para','como','esto','eso','tambiÃ©n','pero','mÃ¡s','muy','bien','hola','gracias','sÃ­','quÃ©','cÃ³mo','cuÃ¡ndo','tengo','estoy','estÃ¡','yo','tÃº','Ã©l','ella','nosotros'];
  const frW = ['le','la','les','un','une','des','que','de','en','avec','pour','comme','aussi','mais','plus','trÃ¨s','bonjour','merci','oui','je','tu','il','elle','nous','vous','ils','comment','quand','oÃ¹'];
  const words = t.split(/\s+/);
  let es = 0, fr = 0;
  words.forEach(w => {
    const c = w.replace(/[^a-zÃ¡Ã©Ã­Ã³ÃºÃ Ã¢Ã¨ÃªÃ®Ã´Ã¹Ã»Ã§]/g,'');
    if (esW.includes(c)) es++;
    if (frW.includes(c)) fr++;
  });
  if (/[Â¿Â¡Ã±]/.test(t)) es += 3;
  if (/[Ã Ã¢Ã¨ÃªÃ®Ã´Ã¹Ã»Å“Ã¦]/.test(t)) fr += 3;
  return es > fr ? 'es' : 'fr';
}

// â”€â”€ TRADUCTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function translate(text, from, to) {
  try {
    const r = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${from}|${to}`);
    const d = await r.json();
    if (d.responseStatus === 200) return d.responseData.translatedText;
  } catch(e) {}
  return '[erreur]';
}

// â”€â”€ TTS iOS-SAFE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Sur iOS, speechSynthesis doit Ãªtre appelÃ© DANS un handler de tap.
// On stocke le texte en attente et on affiche le bouton.
function speak(text, lang) {
  return new Promise(resolve => {
    pendingText = text;
    pendingLang = lang;

    // Montre le bouton Ã‰COUTER
    listenBtn.classList.add('visible');
    setStatus('ğŸ‘†  APPUYEZ POUR Ã‰COUTER');

    // RÃ©sout quand playPending est appelÃ© et que l'audio finit
    window._ttsResolve = resolve;
  });
}

function playPending() {
  if (!pendingText) return;
  listenBtn.classList.remove('visible');

  const text = pendingText;
  const lang = pendingLang;
  pendingText = null;
  pendingLang = null;

  const utt = new SpeechSynthesisUtterance(text);
  utt.lang = lang === 'fr' ? 'fr-FR' : 'es-ES';
  utt.rate = 0.9;
  utt.volume = 1;

  // Choisir la meilleure voix
  const voices = window.speechSynthesis.getVoices();
  const langCode = lang === 'fr' ? 'fr' : 'es';
  const voice = voices.find(v => v.lang.startsWith(langCode)) || null;
  if (voice) utt.voice = voice;

  const finish = () => {
    setStatus('ğŸ™  Ã‰COUTE EN COURSâ€¦');
    if (window._ttsResolve) { window._ttsResolve(); window._ttsResolve = null; }
  };

  utt.onend = finish;
  utt.onerror = finish;
  setTimeout(finish, Math.max(4000, text.length * 80));

  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utt);
  setStatus('ğŸ”Š  LECTUREâ€¦');
  setSys('VOCAL ACTIF');
}

// â”€â”€ HISTORIQUE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addHistory(flag, orig, trans) {
  convCount++;
  document.getElementById('convCount').textContent = String(convCount).padStart(2,'0');
  const hist = document.getElementById('history');
  const d = document.createElement('div');
  d.className = 'hist';
  d.textContent = `${flag}  ${orig}  â†’  ${trans}`;
  hist.prepend(d);
  while (hist.children.length > 3) hist.removeChild(hist.lastChild);
}

// â”€â”€ RECONNAISSANCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startListening() {
  if (!SR || !running || speaking) return;

  recognition = new SR();
  recognition.lang = 'fr-FR';
  recognition.continuous = false;
  recognition.interimResults = true;

  let final = '';

  setListening(true);
  setStatus('ğŸ™  Ã‰COUTE EN COURSâ€¦');
  setSys('MICRO ACTIF');

  recognition.onresult = e => {
    final = '';
    let interim = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim = e.results[i][0].transcript;
    }
    setStatus('ğŸ™  ' + (final || interim).trim().substring(0, 60));
    clearTimeout(silenceTimer);
    if (final.trim()) {
      silenceTimer = setTimeout(() => process(final.trim()), 1000);
    }
  };

  recognition.onend = () => {
    setListening(false);
    if (!final.trim() && running && !speaking) {
      setTimeout(startListening, 300);
    }
  };

  recognition.onerror = e => {
    if (e.error !== 'no-speech' && e.error !== 'aborted') setStatus('ERREUR: ' + e.error);
  };

  recognition.start();
}

async function process(text) {
  if (!running) return;
  speaking = true;
  clearTimeout(silenceTimer);
  try { recognition && recognition.stop(); } catch(e) {}
  setListening(false);

  const lang = detectLang(text);
  const target = lang === 'fr' ? 'es' : 'fr';
  const flag = lang === 'fr' ? 'ğŸ‡«ğŸ‡·' : 'ğŸ‡ªğŸ‡¸';
  const targetFlag = lang === 'fr' ? 'ğŸ‡ªğŸ‡¸' : 'ğŸ‡«ğŸ‡·';

  setStatus('âš™  TRADUCTIONâ€¦');
  setSys('NEURAL PROCESSING');

  const translated = await translate(text, lang, target);

  // Update panels
  if (lang === 'fr') {
    document.getElementById('origFr').textContent = text;
    document.getElementById('transFr').textContent = translated;
    document.getElementById('origEs').textContent = 'â€”';
    document.getElementById('transEs').textContent = 'â€”';
  } else {
    document.getElementById('origEs').textContent = text;
    document.getElementById('transEs').textContent = translated;
    document.getElementById('origFr').textContent = 'â€”';
    document.getElementById('transFr').textContent = 'â€”';
  }
  flashPanel(lang);
  addHistory(targetFlag, text, translated);

  // Sur iOS on attend le tap
  await speak(translated, target);

  speaking = false;
  if (running) {
    setSys('MICRO ACTIF');
    setTimeout(startListening, 400);
  }
}

// â”€â”€ POWER BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('powerBtn').addEventListener('click', () => {
  if (!running) {
    if (!SR) { setStatus('âŒ NAVIGATEUR NON COMPATIBLE'); return; }
    running = true;
    document.getElementById('powerBtn').classList.add('on');
    document.getElementById('powerIcon').textContent = 'â¹';
    document.getElementById('powerLabel').textContent = 'ARRÃŠTER';
    setSys('SYSTÃˆME ACTIF');

    // PrÃ©-charger les voix (important iOS)
    window.speechSynthesis.getVoices();

    startListening();
  } else {
    running = false;
    speaking = false;
    pendingText = null;
    pendingLang = null;
    clearTimeout(silenceTimer);
    try { recognition && recognition.stop(); } catch(e) {}
    window.speechSynthesis.cancel();
    listenBtn.classList.remove('visible');
    setListening(false);
    setStatus('SYSTÃˆME ARRÃŠTÃ‰');
    setSys('VEILLE');
    document.getElementById('powerBtn').classList.remove('on','hearing');
    document.getElementById('powerIcon').textContent = 'â»';
    document.getElementById('powerLabel').textContent = 'DÃ‰MARRER';
  }
});

// PrÃ©-charge les voix dÃ¨s que possible
if (window.speechSynthesis) {
  window.speechSynthesis.getVoices();
  window.speechSynthesis.addEventListener('voiceschanged', () => window.speechSynthesis.getVoices());
}
</script>

</body>
</html>
